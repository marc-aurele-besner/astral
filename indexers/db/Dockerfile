FROM hasura/graphql-engine:v2.40.0

# Set environment variables that will be provided at runtime (can be set via a .env file or Docker Compose)
ENV DB_USER=${DB_USER}
ENV DB_PASSWORD=${DB_PASSWORD}
ENV DB_HOST=${DB_HOST}
ENV DB_PORT=${DB_PORT}
ENV DB_DATABASE=${DB_DATABASE}
ENV DB_CONSENSUS=${DB_CONSENSUS}
ENV DB_LEADERBOARD=${DB_LEADERBOARD}
ENV DB_ACCOUNTS=${DB_ACCOUNTS}
ENV DB_STAKING=${DB_STAKING}
ENV DB_TESTNET_REWARDS=${DB_TESTNET_REWARDS}
ENV HASURA_GRAPHQL_METADATA_DATABASE_URL=postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_DATABASE}
ENV HASURA_GRAPHQL_CONSENSUS_DATABASE_URL=postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_CONSENSUS}
ENV HASURA_GRAPHQL_STAKING_DATABASE_URL=postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_ACCOUNTS}
ENV HASURA_GRAPHQL_ACCOUNTS_DATABASE_URL=postgres://${DB_USER}:${DB_PASSWORD}@db:${DB_PORT}/${DB_LEADERBOARD}
ENV HASURA_GRAPHQL_STAKING_DATABASE_URL=postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_STAKING}
ENV HASURA_GRAPHQL_TESTNET_REWARDS_DATABASE_URL=postgres://${DB_USER}:${DB_PASSWORD}@${DB_HOST}:${DB_PORT}/${DB_TESTNET_REWARDS}
ENV HASURA_GRAPHQL_ENABLE_CONSOLE=false
ENV HASURA_GRAPHQL_DEV_MODE=true
ENV HASURA_GRAPHQL_ADMIN_SECRET=${HASURA_GRAPHQL_ADMIN_SECRET}
ENV HASURA_GRAPHQL_UNAUTHORIZED_ROLE=user
ENV HASURA_GRAPHQL_STRINGIFY_NUMERIC_TYPES=true

RUN yarn install

# Expose the Hasura default port
EXPOSE 8080

# Set the default command to run the Hasura GraphQL Engine
CMD ["graphql-engine", "serve"]